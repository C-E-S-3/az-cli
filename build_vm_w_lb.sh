source ./az_cli_utils.sh

LOCATION="eastus"
PREFIX="CES-DEV"
SSH_KEYFILE=/Users/ces/.ssh/azure_ansible_id_rsa.pub
OS_IMAGE="Ubuntu2204"
#VM_SIZE="Standard_B1ls" #1, .5
VM_SIZE="Standard_B2s" #2, 4
ZSCALER_IPS="147.161.174.0/23 185.46.212.0/23 147.161.172.0/23 165.225.240.0/23 147.161.232.0/23 147.161.234.0/23 147.161.224.0/23 147.161.226.0/23 147.161.228.0/23 147.161.230.0/23 165.225.12.0/23 196.23.154.96/27 165.225.194.0/23 147.161.160.0/23 165.225.72.0/22 165.225.26.0/23 147.161.164.0/23 197.98.201.0/24 147.161.162.0/23 154.113.23.0/24 165.225.80.0/22 147.161.166.0/23 165.225.16.0/23 165.225.92.0/23 165.225.196.0/23 165.225.198.0/23 147.161.178.0/23 147.161.180.0/23 147.161.182.0/23 165.225.202.0/23 165.225.66.0/24 165.225.90.0/23 147.161.176.0/23 147.161.168.0/23 147.161.170.0/23 213.52.102.0/24 165.225.76.0/23 165.225.20.0/23 147.161.184.0/23 165.225.204.0/23 165.225.192.0/23 94.188.139.64/26 165.225.200.0/23 165.225.206.0/23 165.225.94.0/23 192.127.94.77 192.127.94.7 104.129.204.0/23 136.226.2.0/23 104.129.206.0/23 136.226.54.0/23 136.226.56.0/23 136.226.58.0/23 136.226.60.0/23 136.226.62.0/23 136.226.64.0/23 136.226.70.0/23 136.226.72.0/23 136.226.74.0/23 165.225.56.0/22 104.129.196.0/23 165.225.60.0/22 128.177.125.0/24 165.225.0.0/23 137.83.154.0/24 165.225.2.0/24 136.226.66.0/23 136.226.68.0/23 165.225.34.0/23 165.225.216.0/23 165.225.32.0/23 165.225.36.0/23 165.225.10.0/23 104.129.198.0/23 136.226.0.0/23 165.225.222.0/23 165.225.212.0/23 165.225.38.0/23 165.225.220.0/23 165.225.218.0/23 104.129.192.0/23 165.225.242.0/23 64.215.22.0/24 165.225.214.0/23 147.161.128.0/23 165.225.50.0/23 165.225.14.0/23 165.225.208.0/23 165.225.210.0/23 104.129.194.0/23 136.226.48.0/23 136.226.52.0/23 165.225.8.0/23 136.226.50.0/23 124.248.141.0/24 211.144.19.0/24 165.225.104.0/24 165.225.122.0/23 165.225.116.0/23 165.225.234.0/23 112.137.170.0/24 165.225.98.0/24 165.225.226.0/23 165.225.106.0/23 165.225.120.0/23 165.225.124.0/23 147.161.192.0/23 165.225.228.0/23 1.234.57.0/24 58.220.95.0/24 165.225.112.0/23 165.225.230.0/23 175.45.116.0/24 165.225.114.0/23 165.225.232.0/23 165.225.102.0/24 221.122.91.0/24 165.225.110.0/23 165.225.96.0/23"

read -p "VMName: " NAME
read -p "Admin: " ADMIN_USER_NAME

SUBSCRIPTION_ID="CES-DEV"
BASE_NAME=$PREFIX-$NAME
echo $BASE_NAME
RESOURCEGROUP_NAME=$BASE_NAME-rg
VNET_NAME=$BASE_NAME-vnet
SUBNET_NAME=$BASE_NAME-subnet
PUBLICIP_NAME=$BASE_NAME-public-ip
PUBLICNIC_NAME=$BASE_NAME-public-nic
PRIVATENIC_NAME=$BASE_NAME-private-nic
FRONTENDIP=$BASE_NAME-frontend-ip
BACKENDIP=$BASE_NAME-backend-ip
NSG_NAME=$BASE_NAME-nsg
NSGRULE_NAME=AllowSSHInbound
NIC_NAME=$BASE_NAME-nic
VM_NAME=$BASE_NAME-VM0
HEALTHPROBE_NAME=$BASE_NAME-HealthProbe
PROBEPORTNUMBER=22
LOADBALANCER_NAME=$BASE_NAME-lb
LOADBALANCERRULE=$BASE_NAME-SSH
NATRULE_NAME=$BASE_NAME-SSH-INBOUND-nat-rule
FRONTENDIP_NAME=$BASE_NAME-frontend-ip
BACKENDIP_POOL=$BASE_NAME-backend-ip-pool
NATGATEWAYIP_NAME=$BASE_NAME-gateway-ip
NATGATEWAY_NAME=$BASE_NAME-nat-gateway
FRONTENDPORT=22
BACKENDPORT=22
IPCONFIG_NAME=$BASE_NAME-ip-config

create_rg $RESOURCEGROUP_NAME $LOCATION
create_vnet $RESOURCEGROUP_NAME $VNET_NAME $SUBNET_NAME
#create_public_ip_lb $RESOURCEGROUP_NAME $NATGATEWAYIP_NAME
create_public_ip $RESOURCEGROUP_NAME $FRONTENDIP
#create_public_ip_lb $RESOURCEGROUP_NAME $FRONTENDIP
create_nsg $RESOURCEGROUP_NAME $NSG_NAME
create_nsg_SSH_rule $RESOURCEGROUP_NAME $NSG_NAME $NSGRULE_NAME "$ZSCALER_IPS"
#create_nic_public $RESOURCEGROUP_NAME $PUBLICNIC_NAME $VNET_NAME $SUBNET_NAME $FRONTENDIP
create_loadbalancer $RESOURCEGROUP_NAME $LOADBALANCER_NAME $FRONTENDIP $FRONTENDIP_NAME $BACKENDIP_POOL
create_nic_private $RESOURCEGROUP_NAME $PRIVATENIC_NAME $VNET_NAME $SUBNET_NAME
create_backend_pool $RESOURCEGROUP_NAME $BACKENDIP_POOL $PRIVATENIC_NAME $LOADBALANCER_NAME ipconfig1
#create_health_probe $RESOURCEGROUP_NAME $LOADBALANCER_NAME $HEALTHPROBE_NAME $PROBEPORTNUMBER
#create_loadbalancer_rule $RESOURCEGROUP_NAME $LOADBALANCER_NAME $LOADBALANCERRULE $FRONTENDIP_NAME $HEALTHPROBE_NAME
#create_nat_gateway $RESOURCEGROUP_NAME $NATGATEWAY_NAME $NATGATEWAYIP_NAME
#add_gateway_vnet $RESOURCEGROUP_NAME $VNET_NAME $SUBNET_NAME $NATGATEWAY_NAME
add_nsg_vnet $RESOURCEGROUP_NAME $VNET_NAME $SUBNET_NAME $NSG_NAME
create_vm $RESOURCEGROUP_NAME $VM_NAME $LOCATION $OS_IMAGE $VM_SIZE $PRIVATENIC_NAME $ADMIN_USER_NAME $SSH_KEYFILE
create_inbound_nat_rule_nic $RESOURCEGROUP_NAME $LOADBALANCER_NAME $NATRULE_NAME $FRONTENDIP_NAME $FRONTENDPORT $BACKENDPORT
add_inbound_nat_rule_lb $RESOURCEGROUP_NAME $NATRULE_NAME $PRIVATENIC_NAME $LOADBALANCER_NAME ipconfig1
